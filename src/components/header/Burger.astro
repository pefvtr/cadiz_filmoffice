---
import { Icon } from "astro-icon/components";
import { menuItems } from "./Header.astro";

interface Props {
  classNames?: string;
}

const { classNames = "" } = Astro.props;

const currentPath = Astro.url.pathname;

const phrases = [
  {
    id: 1,
    text: "La ciudad que posa para la eternidad",
  },
  {
    id: 2,
    text: "Donde cada rincón cuenta una historia",
  },
  {
    id: 3,
    text: "Un decorado vivo de mil historias",
  },

  {
    id: 4,
    text: "El alma de Cádiz, en cada fotograma",
  },
];
---

<div
  class:list={[
    "relative top-0 right-2 z-50 flex items-center gap-3 lg:right-4 lg:hidden",
    classNames,
  ]}
>
  <div class="text relative">
    <div class="menu-text text-primary text-sm">Menu</div>
    <div
      class="close-text invisible absolute top-0 left-0 translate-y-[25%] rotate-[7deg] text-sm opacity-0"
    >
      Cerrar
    </div>
  </div>
  <div class="burger-icon">
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<div
  class="menu-overlay fixed top-0 left-0 h-screen w-full bg-[#0f0f0f] [clip-path:polygon(0%_0%,100%_0%,100%_0%,0%_0%)]"
>
  <div
    class="menu-content transform:[translateX(-100px)] transform:[translateY(-100px)] relative flex h-full w-full origin-bottom-left scale-150 rotate-[-15deg] flex-col items-center justify-center"
  >
    <div
      class="menu-socials absolute top-9 left-2 flex -translate-y-[50%] gap-2 lg:left-4"
    >
      <div
        class="social-icon hover:text-primary text-white opacity-0 transition-colors duration-300"
      >
        <Icon name="in" class="h-6 w-6" />
      </div>
      <div
        class="social-icon hover:text-primary text-white opacity-0 transition-colors duration-300"
      >
        <Icon name="x" class="h-6 w-6" />
      </div>
    </div>
    <div class="menu-items flex flex-1 flex-col items-center justify-center">
      <div class="col-image">imagen</div>
      <div class="col-nav">
        <nav class="menu-links flex flex-col">
          {
            menuItems.map((item) => (
              <a
                class:list={[
                  "overflow-hidden",
                  { "pointer-events-none": currentPath === item.url },
                ]}
                href={item.url}
              >
                <h2
                  class:list={[
                    "hover:text-primary font-headings hover: translate-y-[120%] px-2 opacity-0 transition-colors duration-300",
                    {
                      "text-primary": currentPath === item.url,
                      "text-white": currentPath !== item.url,
                    },
                  ]}
                >
                  {item.label}
                </h2>
              </a>
            ))
          }
        </nav>
      </div>
    </div>
    <div
      class="menu-footer relative mb-12 w-full overflow-hidden leading-none opacity-0"
    >
      {
        phrases.map((phrase) => (
          <h3
            class:list={[
              "text-center text-base text-white sm:text-lg",
              {
                "absolute top-0 left-0 w-full translate-y-[105%]":
                  phrase.id !== 1,
              },
            ]}
          >
            {phrase.text}
          </h3>
        ))
      }
    </div>
  </div>
</div>

<style>
  .nav-active {
    opacity: 1;
    visibility: visible;
  }
  .header-active {
    background-color: rgba(255, 255, 255, 1);
    backdrop-filter: blur(0px);
  }

  .header-active .horizontal-bar-menu {
    opacity: 0;
  }

  .animate-up .horizontal-bar-menu {
    width: 80px;
  }

  .burger-icon {
    width: 20px; /* Reducido de 35px a 20px */
    height: 17.14px; /* 30px * (20/35) ≈ 17.14px */
    position: relative;
    cursor: pointer;
    transform: rotate(0deg);
    transition: transform 0.35s ease-out; /* Añade esta línea */
    & span {
      display: block;
      position: absolute;
      height: 1.71px; /* 3px * (20/35) ≈ 1.71px */
      width: 50%;
      background: var(--color-primary);
      opacity: 1;

      transform: rotate(0deg);

      transition: 0.8s ease-in-out;
      border-radius: 0.86px; /* 1.5px * (20/35) ≈ 0.86px */
    }

    &:hover span {
      background: var(--color-primary-dark);
    }
  }

  .burger-icon:hover:not(.open) {
    transform: rotate(90deg);
  }

  .burger-icon.open:hover {
    transform: rotate(90deg);
  }

  .burger-icon span:nth-child(even) {
    left: 50%;
    border-radius: 0 1.71px 1.71px 0; /* 3px * (20/35) ≈ 1.71px */
  }

  .burger-icon span:nth-child(odd) {
    left: 0px;
    border-radius: 1.71px 0 0 1.71px; /* 3px * (20/35) ≈ 1.71px */
  }

  /* SEPARACIÓN EQUIDISTANTE - recalculada proporcionalmente */
  .burger-icon span:nth-child(1),
  .burger-icon span:nth-child(2) {
    top: 3.43px; /* 6px * (20/35) ≈ 3.43px */
  }

  .burger-icon span:nth-child(3),
  .burger-icon span:nth-child(4) {
    top: 8.57px; /* 15px * (20/35) ≈ 8.57px */
  }

  .burger-icon span:nth-child(5),
  .burger-icon span:nth-child(6) {
    top: 13.71px; /* 24px * (20/35) ≈ 13.71px */
  }

  /* TRANSFORMACIÓN PARA FORMAR UNA SOLA X - recalculado */
  .burger-icon.open span:nth-child(1) {
    top: 8.57px; /* Centro exacto (15px * (20/35) ≈ 8.57px) */
    left: 0px;
    width: 100%;
    transform: rotate(45deg);
  }

  .burger-icon.open span:nth-child(2) {
    top: 8.57px; /* Mismo centro */
    left: 0px;
    width: 100%;
    transform: rotate(-45deg);
  }

  /* Barras del medio desaparecen hacia los lados */
  .burger-icon.open span:nth-child(3) {
    left: -50%;
    opacity: 0;
  }

  .burger-icon.open span:nth-child(4) {
    left: 100%;
    opacity: 0;
  }

  /* Barras inferiores desaparecen */
  .burger-icon.open span:nth-child(5),
  .burger-icon.open span:nth-child(6) {
    opacity: 0;
    width: 0%;
  }

  .burger-icon.open span {
    background-color: white;
  }
</style>

<script>
  import { gsap } from "gsap";

  document.addEventListener("astro:page-load", () => {
    const burgerIcon = document.querySelector(".burger-icon") as HTMLDivElement;
    const socialIcons = document.querySelectorAll(
      ".social-icon",
    ) as NodeListOf<HTMLDivElement>;
    const menuText = document.querySelector(".menu-text") as HTMLDivElement;
    const closeText = document.querySelector(".close-text") as HTMLDivElement;
    const horizontalBarMenu = document.querySelector(
      ".horizontal-bar-menu",
    ) as HTMLDivElement;
    const mainContainer = document.querySelector(
      ".main-container",
    ) as HTMLDivElement;
    const menuContent = document.querySelector(
      ".menu-content",
    ) as HTMLDivElement;
    const phrases = document.querySelectorAll(
      ".menu-footer h3",
    ) as NodeListOf<HTMLHeadingElement>;
    const menuFooter = document.querySelector(".menu-footer") as HTMLDivElement;

    let isOpen = false;
    let isAnimating = false;
    let tl: gsap.core.Timeline | null = null;

    burgerIcon.addEventListener("click", (e) => {
      const lenis = window.lenis;

      const target = e.currentTarget as HTMLDivElement;

      if (lenis) {
        if (!isOpen) {
          target.classList.add("open");
          lenis.stop();
          openMenu();
        } else {
          target.classList.remove("open");
          lenis.start();
          closeMenu();
        }
      }

      function animateMenuText(isOpening: boolean) {
        gsap.to(isOpening ? menuText : closeText, {
          y: isOpening ? "-25%" : "25%",
          rotate: isOpening ? "-7deg" : "7deg",
          autoAlpha: 0,
          duration: 0.8,
          ease: "power4.inOut",
        });

        gsap.to(isOpening ? closeText : menuText, {
          y: 0,
          rotate: 0,
          autoAlpha: 1,
          duration: 0.8,
          delay: 0.25,
          ease: "power4.inOut",
        });
      }

      function openMenu() {
        if (isAnimating || isOpen) return;
        isAnimating = true;
        tl = gsap.timeline({
          repeat: -1,
        });

        phrases.forEach((phrase) => {
          tl?.to(phrase, {
            y: 0,
          })
            .to(phrase, {
              duration: 3,
            })
            .to(phrase, {
              y: "-105%",
            });
        });

        gsap.set(phrases, { y: "100%" });

        gsap.fromTo(
          menuFooter,
          {
            opacity: 0,
          },
          {
            opacity: 1,
            duration: 1.5,
            ease: "power4.inOut",
            delay: 0.5,
          },
        );

        gsap.to(horizontalBarMenu, {
          width: 0,
          opacity: 0,
          duration: 0.35,
        });

        gsap.to(socialIcons, {
          opacity: 1,
          duration: 1.5,
          ease: "power4.inOut",
          stagger: {
            each: 0.2,
          },
          delay: 0.5,
        });

        /* Este es el contenido de la pagina */
        gsap.to(mainContainer, {
          rotation: 10,
          x: -300,
          y: 1000,
          scale: 1.5,
          duration: 1.25,
          ease: "power4.inOut",
        });

        animateMenuText(true);

        /* Este es el contenido del menu */
        gsap.to(menuContent, {
          x: 0,
          y: 0,
          scale: 1,
          rotation: 0,
          opacity: 1,
          duration: 1.25,
          ease: "power4.inOut",
        });

        /* Animación para el texto del burger */
        gsap.to(closeText, {
          color: "#fff",
          duration: 0.8,
          ease: "power4.inOut",
        });

        gsap.fromTo(
          ".menu-links h2",
          {
            y: "120%",
            opacity: 0,
          },
          {
            y: "0%",
            opacity: 1,
            duration: 2,
            // delay: 0.15,
            stagger: 0.2,
            ease: "power4.inOut",
          },
        );

        /* Animación para el overlay del menú principal */
        gsap.to(".menu-overlay", {
          clipPath: "polygon(0% 0%, 100% 0%, 100% 115%, 0% 100%)",
          duration: 1.25,
          ease: "power4.inOut",
          onComplete: () => {
            isAnimating = false;
            isOpen = true;
          },
        });
      }

      function closeMenu() {
        if (isAnimating || !isOpen) return;
        isAnimating = true;

        // Limpiamos la animación
        tl?.kill();

        // Aquí puedes agregar la lógica para cerrar el menú
        animateMenuText(false);

        /* Animación para el texto del burger */
        gsap.to(menuText, {
          color: "var(--color-primary)",
          duration: 0.8,
          ease: "power4.inOut",
        });

        /* Este es el contenido del menu */
        gsap.to(menuContent, {
          x: -100,
          y: -100,
          scale: 1.5,
          rotation: -15,
          duration: 1.25,
          ease: "power4.inOut",
        });

        gsap.to(socialIcons, {
          opacity: 0,
          duration: 1.25,
          ease: "power4.inOut",
        });

        /* Animación para los enlaces del menu principal */
        gsap.to(".menu-links h2", {
          opacity: 0,
          duration: 2,
          ease: "power4.inOut",
        });

        /* Este es el contenido de la pagina */
        gsap.to(mainContainer, {
          rotation: 0,
          x: 0,
          y: 0,
          scale: 1,
          duration: 1.25,
          ease: "power4.inOut",
        });

        /* Animación para el overlay del menú principal */
        gsap.to(".menu-overlay", {
          clipPath: "polygon(0% 0%, 100% 0%, 100% 0%, 0% 0%)",
          duration: 1.25,
          ease: "power4.inOut",
          onComplete: () => {
            isAnimating = false;
            isOpen = false;
          },
        });

        /* Animación para la línea de la barra del header */
        gsap.to(horizontalBarMenu, {
          width: "min(35%,200px)",
          opacity: 1,
          delay: 0.35,
        });
      }
    });
  });
</script>
