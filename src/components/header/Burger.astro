---
import { menuItems } from "./Header.astro";

interface Props {
  classNames?: string;
}

const { classNames = "" } = Astro.props;

const currentPath = Astro.url.pathname;
---

<div class="relative top-0 right-0 flex items-center gap-3">
  <div class="text relative">
    <div class="menu-text text-sm">Menu</div>
    <div
      class="close-text invisible absolute top-0 left-0 translate-y-[25%] rotate-[7deg] text-sm opacity-0"
    >
      Cerrar
    </div>
  </div>
  <div class:list={["burger-icon", classNames]}>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav
  class="mobile-nav invisible fixed top-(--header-height) left-0 flex h-[calc(100dvh-var(--header-height))] w-full flex-col items-center justify-center bg-white opacity-0 transition-opacity duration-300"
>
  <ul class="flex flex-col items-center justify-center gap-4">
    {
      menuItems.map((item) => (
        <a
          class:list={[
            "hover:text-primary px-2 transition-all hover:[text-shadow:1px_0_0_currentColor]",
            {
              "text-primary pointer-events-none [text-shadow:1px_0_0_currentColor]":
                currentPath === item.url,
            },
          ]}
          href={item.url}
        >
          {item.label}
        </a>
      ))
    }
  </ul>
</nav>

<style>
  .nav-active {
    opacity: 1;
    visibility: visible;
  }
  .header-active {
    background-color: rgba(255, 255, 255, 1);
    backdrop-filter: blur(0px);
  }

  .header-active .horizontal-bar-menu {
    opacity: 0;
  }

  .animate-up .horizontal-bar-menu {
    width: 80px;
  }

  .burger-icon {
    width: 20px; /* Reducido de 35px a 20px */
    height: 17.14px; /* 30px * (20/35) ≈ 17.14px */
    position: relative;
    cursor: pointer;
    transform: rotate(0deg);
    transition: transform 0.35s ease-out; /* Añade esta línea */
    & span {
      display: block;
      position: absolute;
      height: 1.71px; /* 3px * (20/35) ≈ 1.71px */
      width: 50%;
      background: var(--color-primary);
      opacity: 1;

      transform: rotate(0deg);

      transition: 0.8s ease-in-out;
      border-radius: 0.86px; /* 1.5px * (20/35) ≈ 0.86px */
    }

    &:hover span {
      background: var(--color-primary-dark);
    }
  }

  .burger-icon:hover:not(.open) {
    transform: rotate(90deg);
  }

  .burger-icon.open:hover {
    transform: rotate(90deg);
  }

  .burger-icon span:nth-child(even) {
    left: 50%;
    border-radius: 0 1.71px 1.71px 0; /* 3px * (20/35) ≈ 1.71px */
  }

  .burger-icon span:nth-child(odd) {
    left: 0px;
    border-radius: 1.71px 0 0 1.71px; /* 3px * (20/35) ≈ 1.71px */
  }

  /* SEPARACIÓN EQUIDISTANTE - recalculada proporcionalmente */
  .burger-icon span:nth-child(1),
  .burger-icon span:nth-child(2) {
    top: 3.43px; /* 6px * (20/35) ≈ 3.43px */
  }

  .burger-icon span:nth-child(3),
  .burger-icon span:nth-child(4) {
    top: 8.57px; /* 15px * (20/35) ≈ 8.57px */
  }

  .burger-icon span:nth-child(5),
  .burger-icon span:nth-child(6) {
    top: 13.71px; /* 24px * (20/35) ≈ 13.71px */
  }

  /* TRANSFORMACIÓN PARA FORMAR UNA SOLA X - recalculado */
  .burger-icon.open span:nth-child(1) {
    top: 8.57px; /* Centro exacto (15px * (20/35) ≈ 8.57px) */
    left: 0px;
    width: 100%;
    transform: rotate(45deg);
  }

  .burger-icon.open span:nth-child(2) {
    top: 8.57px; /* Mismo centro */
    left: 0px;
    width: 100%;
    transform: rotate(-45deg);
  }

  /* Barras del medio desaparecen hacia los lados */
  .burger-icon.open span:nth-child(3) {
    left: -50%;
    opacity: 0;
  }

  .burger-icon.open span:nth-child(4) {
    left: 100%;
    opacity: 0;
  }

  /* Barras inferiores desaparecen */
  .burger-icon.open span:nth-child(5),
  .burger-icon.open span:nth-child(6) {
    opacity: 0;
    width: 0%;
  }
</style>

<script>
  import { gsap } from "gsap";

  document.addEventListener("astro:page-load", () => {
    const burgerIcon = document.querySelector(".burger-icon") as HTMLDivElement;
    const mobileNav = document.querySelector(".mobile-nav") as HTMLElement;
    const menuText = document.querySelector(".menu-text") as HTMLDivElement;
    const closeText = document.querySelector(".close-text") as HTMLDivElement;
    const horizontalBarMenu = document.querySelector(
      ".horizontal-bar-menu",
    ) as HTMLDivElement;
    const text = document.querySelector(".text") as HTMLDivElement;

    // let tl = gsap.timeline();

    let isOpen = false;
    let isAnimating = false;

    burgerIcon.addEventListener("click", (e) => {
      document.body.classList.toggle("no-scroll");
      document.documentElement.classList.toggle("no-scroll");

      const lenis = window.lenis;

      // console.log("isOpen:", isOpen);

      if (lenis) {
        if (isOpen) {
          lenis.stop();
        } else {
          lenis.start();
        }
      }

      const target = e.currentTarget as HTMLDivElement;
      target.classList.toggle("open");

      if (!isOpen) {
        mobileNav.classList.add("nav-active");
        horizontalBarMenu.classList.add("horizontal-bar-active");
        openMenu();
      } else {
        mobileNav.classList.remove("nav-active");
        horizontalBarMenu.classList.remove("horizontal-bar-active");
        closeMenu();
      }

      function animateMenuText(isOpening: boolean) {
        console.log({ isOpen });
        gsap.to(isOpening ? menuText : closeText, {
          y: isOpening ? "-25%" : "25%",
          rotate: isOpening ? "-7deg" : "7deg",
          autoAlpha: 0,
          duration: 0.8,
          ease: "power4.inOut",
        });

        gsap.to(isOpening ? closeText : menuText, {
          y: 0,
          rotate: 0,
          autoAlpha: 1,
          duration: 0.8,
          delay: 0.25,
          ease: "power4.inOut",
        });
      }

      function openMenu() {
        if (isAnimating || isOpen) return;
        isAnimating = true;
        // Aquí puedes agregar la lógica para abrir el menú
        animateMenuText(true);
        gsap.to(menuText, {
          color: "yellow",
          onComplete: () => {
            isAnimating = false;
            isOpen = true;
          },
        });
      }

      function closeMenu() {
        if (isAnimating || !isOpen) return;
        isAnimating = true;
        // Aquí puedes agregar la lógica para cerrar el menú
        animateMenuText(false);
        gsap.to(menuText, {
          color: "red",
          onComplete: () => {
            isAnimating = false;
            isOpen = false;
          },
        });
      }

      // Limpiar/controlar la timeline
      // tl.clear(); // Limpia animaciones anteriores
      // tl.kill(); // Mata la animación actual si está en progreso

      // Reiniciar timeline
      // tl = gsap.timeline();

      // if (isOpen) {
      //   // Para OCULTAR: anima DESDE el estado visible HACIA oculto
      //   tl.to(menuText, {
      //     duration: 0.8,
      //     ease: "power4.inOut",
      //     y: "-25%",
      //     rotate: "-7deg",
      //     autoAlpha: 0,
      //   }).to(
      //     closeText,
      //     {
      //       duration: 0.8,
      //       ease: "power4.inOut",
      //       y: "0%",
      //       rotate: "0deg",
      //       autoAlpha: 1,
      //     },
      //     "-=0.5", // Superponer la animación de mostrar con la de ocultar
      //   );
      // } else {
      //   // Para MOSTRAR: primero hacer visible, luego animar
      //   tl.to(
      //     closeText,
      //     {
      //       duration: 0.8,
      //       ease: "power4.inOut",
      //       y: "25%",
      //       rotate: "7deg",
      //       autoAlpha: 0,
      //     }, // Superponer la animación de ocultar con la de mostrar
      //   ).to(
      //     menuText,
      //     {
      //       duration: 0.8,
      //       ease: "power4.inOut",
      //       y: "0%",
      //       rotate: "0deg",
      //       autoAlpha: 1,
      //     },
      //     "-=0.5",
      //   );
      // }
    });
  });
</script>
